<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../../resources/libs/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../resources/libs/bootstrap/css/bootstrap-theme.min.css">
    <title>语言Le的计算过程</title>
    <style>
        .title{
            text-align: center;
        }
        .left,.right{
            height: 500px;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">语言L<sub>e</sub>的计算过程动画演示</h1>
        <div class="left col-md-6">
            <div class="form-group">
                <input type="text" id="control" class="form-control control" placeholder="Control">
            </div>
            <div class="form-group">
                <input type="text" id="denv" class="form-control denv" placeholder="DEnv">
            </div>
            <div class="form-group">
                <input type="button" class="btn btn-primary" value="开始">
                <input type="button" class="btn btn-primary" value="运行">
            </div>
        </div>
        <div class="right col-md-6">
            <div class="board">
                
            </div>
        </div>
    </div>
<script src="../../resources/libs/jquery/jquery.min.js"></script>
<script>
$(function(){
    var rule = {
        CONS: '常量规则：(vs, const(c):e, sita) => (c:vs, e, sita)',

        VAR: '变量规则：(vs, var(c):e, sita) => (sita(x):vs, e, sita)',

        DEV: '除法规则：(n1:n2:vs, div:e, sita) => (n:vs, e, sita), n= n1/n2',

        MUL: '乘法规则：(n1:n2:vs, mul:e, sita) => (n:vs, e, sita), n= n1*n2',

        ADD: '加法规则：(n1:n2:vs, add:e, sita) => (n:vs, e, sita), n= n1+n2',

        SUB: '减法规则：(n1:n2:vs, sub:e, sita) => (n:vs, e, sita), n= n1-n2',

        SE: '比较规则：(n1:n2:vs, se:e, sita) => (n:vs, e, sita), n = (n1<=n2)',

        GE: '比较规则：(n1:n2:vs, ge:e, sita) => (n:vs, e, sita), n = (n1>=n2)',

        OP: '分解规则:(vs, op(e1,e2):e, sita) => (vs, e2:e1:op:e, sita)'
    };


    window.control = '[ge(add(var(x),mul(cons(2),var(y))),var(z))]';
    //window.control = 'cons(20),add(var(x),mul(cons(2),var(y))),ge';
    window.partone = '';
    window.denv = '[x->34, y->7, z->50]';
    window.denv_obj = {};
    window.stack_arr = [];

    // 去掉中括号[]
    function clear_bracket(control){
        var firstChar = control.substring(0, 1);
        if(firstChar=='['){
            control = control.substring(1,control.length-1);
        }
        //console.log(control);
        return control;
    }
    window.control = clear_bracket(window.control);
    //console.log(window.control);

    //得到全局第一部分
    function get_global_partone(control){
        var len = control.length;
        var i = 0;
        var ret = '';
        var flag = 0;
        while(i < len && control.charAt(i) == ' '){
           i++; 
        } 
        while(i < len && (control.charAt(i) != ',' || flag != 0)) {
            ret += control.charAt(i);
            if(control.charAt(i) == '(') flag ++;
            if(control.charAt(i) == ')') flag --;
            i ++;
        }
        return ret;
    }
    window.partone = clear_bracket(window.partone);
    window.partone = get_global_partone(window.control);
    //console.log(window.partone);

    //得到全局第二部分
    function get_global_parttwo(control){
        var len = control.length;
        var i = 0;

        var flag = 0;
        while(i < len && control.charAt(i) == ' ') i ++;
        while(i < len && (control.charAt(i) != ',' || flag != 0)) {
            if(control.charAt(i) == '(') flag ++;
            if(control.charAt(i) == ')') flag --;
            i ++;
        }
        i ++;
        while(i < len && control.charAt(i) == ' '){
           i ++; 
        } 
        var ret = '';
        while(i < len ) {
            ret += control.charAt(i);
            i ++;
        }
        return ret;
    }
    window.parttwo = get_global_parttwo(window.control);
    //console.log(window.parttwo);

    // 转化denv为对象
    function get_denv_obj(denv){
        var denv = clear_bracket(denv);
        //console.log(denv);
        var denv_arr = denv.split(',');
        //console.log(denv_arr[0]);
        var denv_obj={};
        for(var i=0;i<denv_arr.length;i++){
            var entry = denv_arr[i].trim();
            var key = entry.split('->')[0];
            var value = entry.split('->')[1];
            denv_obj[key]=value;
        }
        return denv_obj;
    }
    window.denv_obj = get_denv_obj(denv);
    //console.log(denv_obj);

    //得到操作符
    function get_opration(control){
        var reg=/\w+/;
        var operation = control.match(reg)[0];
        //console.log(operation);
        return operation;
    }

    //得到第一部分
    function get_partone(control) {
        var len = control.length;
        var i = 0;
        // 跳过操作符和(
        while(i < len && control.charAt(i) != '('){
           i ++; 
        } 
        i ++;
        var ret = '';
        var flag = 0;
        while(i < len && control.charAt(i) == ' '){
           i++; 
        } 
        while(i < len && (control.charAt(i) != ',' || flag != 0)) {
            ret += control.charAt(i);
            if(control.charAt(i) == '(') flag ++;
            if(control.charAt(i) == ')') flag --;
            i ++;
        }
        return ret;
    }

    //得到第二部分
    function get_parttwo(control) {
        var len = control.length;
        var i = 0;
        while(i < len && control.charAt(i) != '('){
           i ++; 
        } 
        i ++;

        var flag = 0;
        while(i < len && control.charAt(i) == ' ') i ++;
        while(i < len && (control.charAt(i) != ',' || flag != 0)) {
            if(control.charAt(i) == '(') flag ++;
            if(control.charAt(i) == ')') flag --;
            i ++;
        }
        i ++;
        while(i < len && control.charAt(i) == ' '){
           i ++; 
        } 
        var ret = '';
        while(i < len - 1) {
            ret += control.charAt(i);
            i ++;
        }
        return ret;
    }

    //得到新的control
    function get_new_control(control){
        var operation = get_opration(control);
        var partone = get_partone(control);
        var parttwo = get_parttwo(control);
        //console.log(partone);
        //console.log(parttwo);
        var new_control = parttwo+','+partone+','+operation;
        
        return new_control;
    }

    function control_equals_partone(){
        var operation = get_opration(window.control);
        if(operation=='ge'){
            console.log(rule.GE);
        }else if(operation=='add'){
            console.log(rule.ADD);
        }else if(operation=='sub'){
            console.log(rule.SUB);
        }
        var new_control = get_new_control(window.control);
        window.control = new_control;
        window.partone = get_global_partone(window.control);
    }

    function control_not_equals_partone(){
        var operation = get_opration(window.control);
        if(operation == 'cons'){
            var first = control.split(',')[0];
            //console.log(first);
            var reg = /\d+/ ;
            var num = first.match(reg)[0];
            //console.log(num);
            var len = window.stack_arr.length;
            window.stack_arr[len]=num;
            //删除指定元素
            //stack_arr.splice(stack_arr.length-1);
            //console.log(stack_arr.length);
            window.control = control.slice(first.length+1,window.control.length).trim();
            window.partone = get_global_partone(window.control);
            
        }else if(operation == 'var'){
            var first = control.split(',')[0];
            //console.log(first);
            var reg = /\(\w+\)/ ;
            var variable = first.match(reg)[0];
            variable = variable.substring(1,variable.length-1);
            //console.log(variable);
            var len = window.stack_arr.length;
            window.stack_arr[len]=denv_obj[variable];
            //console.log(stack_arr[len]);
            window.control = control.slice(first.length+1,window.control.length).trim();
            window.partone = get_global_partone(window.control);
        }else{
            if(operation=='ge'){
                console.log(rule.GE);
            }else if(operation=='add'){
                console.log(rule.ADD);
            }else if(operation=='sub'){
                console.log(rule.SUB);
            }
            var new_control = get_new_control(window.partone);
            new_control = new_control +','+ get_global_parttwo(window.control);
            window.control = new_control;
            window.partone = get_global_partone(window.control);
        }
    }

    function one_step(){
        if(window.control == window.partone){
            control_equals_partone();   
        }else{
            control_not_equals_partone();
        }
    }

    console.log(window.control);
    console.log(window.partone);
    console.log(window.stack_arr);
    
    one_step(window.control);
    console.log(window.control);
    console.log(window.partone);
    console.log(window.stack_arr);

    one_step(window.control);
    console.log(window.control);
    console.log(window.partone);
    console.log(window.stack_arr);

    one_step(window.control);
    console.log(window.control);
    console.log(window.partone);
    console.log(window.stack_arr);
    
});
</script>
</body>
</html>